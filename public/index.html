<!doctype html>
<html class="no-js" ng-app="webapp">
<head>
    <title>SnapScan Paylink Generator</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/site.css">  
</head>

<body>
  <div class="box">
      <h1>Create a SnapScan Paylink</h1>

    <div class="inner">
	<div class="form-group">
        <label>SnapCode (required)</label>
		<input id="merchantId" type="text" placeholder="e.g. STB1234"></input>
	</div>
	<div class="form-group">
		<label>Amount (optional)</label>
		<input id="amountOwed" type="number" placeholder="e.g. R500.00"></input>
	</div>
	<div class="form-group">
        <label>Reference (optional)</label>
		<input id="reference" type="text" placeholder="e.g. Order12345"></input>
	</div>
    <div class="form-group center download-action">
        <div class="btn-shadow">
            <a id="generateButton" class="download-btn btn" download="qr-code.jpg">Create Paylink</a>
        </div>
    </div>

    <div id="qr-link-output" class="form-group center actions" style="visibility: hidden">
    <div class="form-group">
        <h2>Your Paylink</h2>
    </div>

        <a target="_blank" id="qrLink" style="display: none">
            <img id="qrImage">
            <br>
        </a>

    <div class="qr-link-output">
        <input  id="output" type="text"></input>
        <br>
        <a data-text="Click this link to pay me using SnapScan" id="whatsappShare" class="whatsapp w3_whatsapp_btn w3_whatsapp_btn_large">Share on Whatsapp</a>
        <input type="button" class="btn" value="Open link in new tab" onclick="window.open(qrLink)" style="display: none"/>
    </div>
    </div>
    </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
    // scroll to bottom of page after generate
    // copy text to clip board ; http://stackoverflow.com/questions/400212/how-do-i-copy-to-the-clipboard-in-javascript
    // Share to: Whatsapp, Twitter http://w3lessons.info/2015/03/14/how-to-share-content-on-whatsapp-using-jquery/
    // BulkSMS : http://developer.bulksms.com/eapi/overview.html
    // remove QR and open link button when on mobile
    // Email to customer
    // merchant ID populates from URL
    // generate a QR code
    // only number input
    // SMS text for Mr Delivery - probably pre-filled based on deploy?
    // change
    // <script src="scripts/vendor/qrcode.min.js">
    // <script src="scripts/app.js">


    // on page load
    $('#merchantId').val('');
    $("qr-link-output").hide();

    // whatsapp share button
    $(document).ready(function() {

var isMobile = {
    Android: function() {
        return navigator.userAgent.match(/Android/i);
    },
    BlackBerry: function() {
        return navigator.userAgent.match(/BlackBerry/i);
    },
    iOS: function() {
        return navigator.userAgent.match(/iPhone|iPad|iPod/i);
    },
    Opera: function() {
        return navigator.userAgent.match(/Opera Mini/i);
    },
    Windows: function() {
        return navigator.userAgent.match(/IEMobile/i);
    },
    any: function() {
        return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
    }
            };
 $(document).on("click", '.whatsapp', function() {
        if( isMobile.any() ) {

            var text = $(this).attr("data-text");
            var url = $(this).attr("data-link");
            var message = encodeURIComponent(text) + " - " + encodeURIComponent(url);
            var whatsapp_url = "whatsapp://send?text=" + message;
            window.location.href = whatsapp_url;
        } else {
            alert("Please share this article in mobile device");
        }

    });
});

    //button : create link
  $('#generateButton').click(function() {
      var merchantId = $('#merchantId').val();
      var amountOwed = $('#amountOwed').val();
      var reference = $('#reference').val();
      var output = generate(merchantId, amountOwed, reference);
      var qrImage = (generateQR(merchantId, amountOwed, reference));
      var page=document.getElementById('qr-link-output');

      if (merchantId) {
      $('#output').val(output);
      $('#output').select();
      $('#qrImage').attr("src",qrImage)
      $('#snapscan-qr-image').attr("src",qrImage)
      $('#qrLink').attr("href",output)
      $('#whatsappShare').attr("data-link",output)
      page.style.visibility='visible';
      $('#amountOwed').val('');
      $('#reference').val('');

      }
      else {
      alert("Please enter a merchantId to create a link")
      }

    });

    function copyToClipboard(text) {
        window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
      }

    // get parameter from URL
    $.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return results[1] || 0;
    }
    }

    // generate PayLink
    function generate(merchantId, amountOwed, reference) {
        var paylink = "https://pos.snapscan.io/qr/" + merchantId

        if (amountOwed || reference) {
        paylink = paylink + "?";

        if (amountOwed) {
        paylink = paylink + "&amount=" + amountOwed*100;
        }

        if (reference) {
        paylink = paylink + "&id=" + reference;
        }

        }

        return paylink;
    }

    // generate link for QR code
    function generateQR(merchantId, amountOwed, reference) {
        var qrlink = "https://pos.snapscan.io/qr/" + merchantId + '.svg'

        if (amountOwed !== null || reference !== null) {
        qrlink = qrlink + "?";

        if (amountOwed !== null) {
        qrlink = qrlink + "&amount=" + amountOwed*100;
        }

        if (reference !== null) {
        qrlink = qrlink + "&id=" + reference;
        }

        }

        qrlink = qrlink + "&snap_code_size=250";

        return qrlink;
    }


</script>

</body>
